@page "/register"

@using ProjektZaliczeniowyPR3.Data
@using ProjektZaliczeniowyPR3.DatabaseConnection
@using ProjektZaliczeniowyPR3.Models

@inject NavigationManager Navigator


<PageTitle>Nowe konto</PageTitle>
<h1>Nowe konto</h1><br/>
<div class = "register_prompt">
    <p>Nazwa użytkownika</p>
    <input @bind = "username">
    <br/>
    <p>Hasło</p>
    <input @bind = "password">
    <Switch @ref="adminSwitch" @bind-Value="isAdmin" Label="Czy użytkownik jest administratorem?"/>
    <div class = "register_button">
        <button @onclick = "AddUser">Zarejestruj</button>
    </div>
</div>

@if (displayErrorMessages)
{
<div class = "error_message" style = "color: red;">
    @if (username.Length == 0)
    {
        @errorMessages[0]
    }
    @if (password.Length  == 0)
    {
        @errorMessages[1]
    }
    @if (userExists)
    {
        @errorMessages[2]
    }
</div>
}


<div class = "database_status">
    <p>Status połączenia z bazą danych:</p>
    @if (!ifConnectionSuccessful)
    {
        <p style = "color: red"><b>Brak połączenia z bazą danych!</b></p>
    }
    else
    {
        <p style = "color: green"><b>Połączono pomyślnie</b></p>
    }
</div>

@code {

    string username = "", password = "";
    private Switch adminSwitch = default!;

    private Hashing hash = new();
    private bool isAdmin = false, ifConnectionSuccessful = false, displayErrorMessages = false;

    private void Disable() => adminSwitch.Disable();

    private void Enable() => adminSwitch.Enable();

    bool userExists = false;

    string[] errorMessages = ["Nie podano loginu!", "Nie podano hasła!", "Użytkownik istnieje!"];

    protected override void OnInitialized()
    {
        ConnectionInfo info = new();
        ifConnectionSuccessful = info.TryConnection();
    }


    protected void AddUser()
    {
        if (username.Length == 0 || password.Length == 0)
        {
            displayErrorMessages = true;
            return;
        }
        Logs newLog = new();
        User newUser = new();
        newUser.Username = username;
        newUser.Password = password;
        newUser.salt = hash.GetSalt();
        newUser.Password = hash.GetHash(password, newUser.salt);
        newUser.isAdmin = isAdmin;
        List <User> users;
        using (var db = new LibraryContext())
        {
            try {
                db.Database.CanConnect();
            }
            catch (Exception e)
            {
                Console.WriteLine(e.Message);
            }
            finally {}
            users = db.users
            .ToList();
        }
        foreach (var user in users)
        {
            if (user.Username == username)
            {
                userExists = true;
                return;
            }
        }
        newLog.Username = username;
        newLog.OperationsType = Logs.OperationType.UserRegister;
        userExists = false;
        using (var db = new LibraryContext())
        {
            try {
                db.Database.CanConnect();
            }
            catch (Exception e)
            {
                Console.WriteLine(e.Message);
            }
            finally {}
            db.users.Add(newUser);
            db.SaveChanges();
            db.logs.Add(newLog);
            db.SaveChanges();
        }

        this.StateHasChanged();

        //Navigator.NavigateTo("/account");

    }
}