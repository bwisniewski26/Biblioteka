@page "/register"

@using ProjektZaliczeniowyPR3.Data
@using ProjektZaliczeniowyPR3.DatabaseConnection
@using ProjektZaliczeniowyPR3.Models

@inject NavigationManager Navigator


<PageTitle>Nowe konto</PageTitle>
<h1>Nowe konto</h1><br/>
<div class = "register_prompt">
    <p>Nazwa użytkownika</p>
    <input @bind = "username">
    <br/>
    <p>Hasło</p>
    <input @bind = "password">
    <Switch @ref="adminSwitch" @bind-Value="isAdmin" Label="Czy użytkownik jest administratorem?"/>
    <div class = "register_button">
        <button @onclick = "AddUser">Zarejestruj</button>
    </div>
</div>

@if (displayErrorMessages)
{
<div class = "error_message" style = "color: red;">
    @if (username.Length == 0)
    {
        @errorMessages[0]
    }
    @if (password.Length  == 0)
    {
        @errorMessages[1]
    }
</div>
}


<div class = "database_status">
    <p>Status połączenia z bazą danych:</p>
    @if (!ifConnectionSuccessful)
    {
        <p style = "color: red"><b>Brak połączenia z bazą danych!</b></p>
    }
    else
    {
        <p style = "color: green"><b>Połączono pomyślnie</b></p>
    }
</div>

@code {

    string username = "", password = "";
    private Switch adminSwitch = default!;
    private bool isAdmin = false, ifConnectionSuccessful = false, displayErrorMessages = false;

    private void Disable() => adminSwitch.Disable();

    private void Enable() => adminSwitch.Enable();

    string[] errorMessages = ["Nie podano loginu!", "Nie podano hasła!"];

    protected override void OnInitialized()
    {
        ConnectionInfo info = new();
        ifConnectionSuccessful = info.TryConnection();
    }


    protected void AddUser()
    {
        if (username.Length == 0 || password.Length == 0)
        {
            displayErrorMessages = true;
            return;
        }
        User newUser = new();
        newUser.Username = username;
        newUser.SetPassword(password);
        newUser.isAdmin = isAdmin;

        using (var db = new LibraryContext())
        {
            try {
                db.Database.CanConnect();
            }
            catch (Exception e)
            {
                Console.WriteLine(e.Message);
            }
            finally {}
            db.users.Add(newUser);
            db.SaveChanges();
        }

        Navigator.NavigateTo("/account");

    }
}