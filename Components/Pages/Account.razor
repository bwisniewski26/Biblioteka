@using BlazorBootstrap
@using ProjektZaliczeniowyPR3.Data
@using ProjektZaliczeniowyPR3.Models

@inject NavigationManager Navigator
@page "/account"

<PageTitle>Panel użytkownika</PageTitle>

@if (!isLoggedIn)
{
    <h1>Logowanie</h1>
    <div class = "login_prompt">
        <p>Nazwa użytkownika</p> 
        <input @bind = "username">
        <br/>
        <p>Hasło</p>
        <input @bind = "password">
        <br/>
        <button Color="ButtonColor.Primary" @onclick = "LogIn" style = "button_login">Zaloguj się</button>
        <p>Nie masz konta? <a href="/register">Zarejestruj się!</a></p>
        <p>@response</p>
    </div>

}
else
{
    <h1>Panel użytkownika</h1>
    <button Color="ButtonColor.Primary" @onclick = "ChangeAdmin">Zmień się w admina</button>
    <p>Zalogowano!</p>
    <button Color="ButtonColor.Primary" @onclick = "LogIn" style = "button_login">Wyloguj się</button>

    @if (isAdmin)
    {
        <p>Dodaj nową książkę</p>
        <br/>
        <p>Tytuł</p>
        <input @bind = "title">
        <br/>
        <p>Autor</p>
        <input @bind = "author">
        <p>Opis</p>
        <input @bind = "desc">
        <button @onclick = "AddBook">Zapisz</button>
    }
    else
    {
        <p>Wypożycz książki</p>
    }
}


@code {
        List<ToastMessage> messages = new List<ToastMessage>();
        private bool isLoggedIn = false;
        private bool isAdmin = false;


        string username = "", password = "", title = "", author = "", desc = "", response = "";

        private void LogIn()
        {
            List<User> users = new();
            using (var db = new LibraryContext())
                {
                    try {
                        db.Database.CanConnect();
                    }
                    catch (Exception e)
                    {
                        Console.WriteLine(e.Message);
                    }
                    finally {}
                    Console.WriteLine("Polaczenie sie udalo :3");
                    users = db.users
                    .ToList();
            }
            
            foreach(var login in users)
            {
                if (login.Username == username)
                {
                    if (login.Password == password)
                    {
                        isAdmin = login.isAdmin;
                        isLoggedIn = true;
                        ShowMessage(ToastType.Success);
                    }
                    else
                    {
                        response = "Niepoprawne hasło!";
                    }
                }
            }

            
        }

        private void ChangeAdmin()
        {
            isAdmin = !isAdmin;
        }

        private void AddBook()
        {
            if (title.Length > 0 && author.Length > 0)
            {
                Book ksiazka = new Book(title, author);
                if (desc.Length > 0)
                {
                    ksiazka.Description = desc;
                }

                using (var db = new LibraryContext())
                {
                    try {
                        db.Database.CanConnect();
                    }
                    catch (Exception e)
                    {
                        Console.WriteLine(e.Message);
                    }
                    finally {}
                    db.books.Add(ksiazka);
                    db.SaveChanges();
                }
            }
            Navigator.NavigateTo("/browse");
        }

        private void ShowMessage(ToastType toastType) => messages.Add(CreateToastMessage(toastType));

        private ToastMessage CreateToastMessage(ToastType toastType)
        => new ToastMessage
        {
            Type = toastType,
            Title = isLoggedIn ? "Zalogowano pomyślnie" : "Wylogowano pomyślnie",
            Message = isAdmin ? "Odblokowano dodawanie książek" : "Miłego wypożyczania! :)",
        };
}